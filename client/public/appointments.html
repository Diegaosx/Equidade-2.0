<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamentos - Cl√≠nica Equidade</title>
  <style>
    :root {
      --primary: #4b6cb7;
      --primary-dark: #3a5a9c;
      --secondary: #182848;
      --text-main: #333;
      --text-light: #666;
      --bg-light: #f5f7fa;
      --bg-white: #ffffff;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e5e7eb;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      line-height: 1.5;
    }
    
    .layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background-color: var(--secondary);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 10;
    }
    
    .logo {
      padding: 0 20px 20px;
      font-size: 24px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    
    .nav-list {
      list-style: none;
    }
    
    .nav-item {
      margin-bottom: 5px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .nav-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 20px;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background-color: var(--bg-white);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 600;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
    }
    
    .user-info {
      margin-right: 15px;
      text-align: right;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      color: var(--text-light);
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .logout-button {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 15px;
    }
    
    .logout-button:hover {
      background-color: #dc2626;
    }
    
    /* Calendar container */
    .calendar-container {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .calendar-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .calendar-button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .calendar-button:hover {
      background-color: var(--primary-dark);
    }
    
    .calendar-button.outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .calendar-button.outline:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    .calendar-view-buttons {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .calendar-view-button {
      background-color: transparent;
      border: none;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .calendar-view-button.active {
      background-color: var(--primary);
      color: white;
    }
    
    /* Table */
    .table-container {
      background-color: var(--bg-white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
      margin-bottom: 30px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      color: var(--text-light);
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-scheduled {
      background-color: rgba(75, 108, 183, 0.1);
      color: var(--primary);
    }
    
    .status-confirmed {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-completed {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-cancelled {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .status-no-show {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .status-pending {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }
    
    .action-button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .action-button.delete {
      color: var(--danger);
    }
    
    /* Button */
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .button-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .button-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .button-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .button-outline:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    /* Search input */
    .search-container {
      position: relative;
      width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.span-2 {
      grid-column: span 2;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    .form-text {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    .error-message {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    
    .checkbox-group input {
      margin-right: 8px;
    }
    
    /* Calendar display */
    .calendar {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .calendar-weekday {
      text-align: center;
      padding: 10px;
      font-weight: 500;
      background-color: #f8f9fc;
      border-bottom: 1px solid var(--border);
    }
    
    .calendar-day {
      height: 120px;
      padding: 10px;
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      overflow-y: auto;
      position: relative;
    }
    
    .calendar-grid .calendar-day:nth-child(7n) {
      border-right: none;
    }
    
    .calendar-grid .calendar-day:nth-last-child(-n+7) {
      border-bottom: none;
    }
    
    .calendar-day-number {
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .calendar-day.today {
      background-color: rgba(75, 108, 183, 0.05);
    }
    
    .calendar-day.today .calendar-day-number {
      color: var(--primary);
      font-weight: 600;
    }
    
    .calendar-day.other-month {
      background-color: #f8f9fc;
      color: var(--text-light);
    }
    
    .appointment {
      background-color: var(--primary);
      color: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 5px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .appointment.completed {
      background-color: var(--success);
    }
    
    .appointment.cancelled {
      background-color: var(--danger);
      text-decoration: line-through;
    }
    
    .appointment.pending {
      background-color: var(--warning);
    }
    
    /* Weekly view */
    .weekly-calendar {
      display: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .time-slots {
      display: flex;
    }
    
    .time-labels {
      width: 60px;
      border-right: 1px solid var(--border);
    }
    
    .time-label {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    
    .weekly-days {
      display: flex;
      flex: 1;
    }
    
    .weekly-day {
      flex: 1;
      border-right: 1px solid var(--border);
    }
    
    .weekly-day:last-child {
      border-right: none;
    }
    
    .weekly-day-header {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
    }
    
    .weekly-day-header.today {
      background-color: rgba(75, 108, 183, 0.05);
      color: var(--primary);
    }
    
    .weekly-appointments {
      position: relative;
      height: 960px; /* 16 hours * 60px */
    }
    
    .weekly-appointment {
      position: absolute;
      left: 0;
      right: 0;
      background-color: var(--primary);
      color: white;
      border-radius: 4px;
      padding: 4px;
      font-size: 12px;
      overflow: hidden;
      cursor: pointer;
      margin: 0 2px;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-label {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .filter-control {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      min-width: 150px;
    }
    
    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    
    .empty-icon {
      font-size: 48px;
      color: var(--text-light);
      margin-bottom: 16px;
    }
    
    .empty-text {
      font-size: 16px;
      color: var(--text-light);
      margin-bottom: 24px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-menu {
        margin-top: 15px;
        width: 100%;
        justify-content: space-between;
      }
      
      .calendar-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .calendar-controls {
        margin-top: 15px;
        width: 100%;
        justify-content: space-between;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group.span-2 {
        grid-column: span 1;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">Cl√≠nica Equidade</div>
      <nav>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/dashboard.html" class="nav-link">
              <span class="nav-icon">üìä</span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="/patients.html" class="nav-link">
              <span class="nav-icon">üë•</span>
              Pacientes
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">üë®‚Äç‚öïÔ∏è</span>
              Profissionais
            </a>
          </li>
          <li class="nav-item">
            <a href="/appointments.html" class="nav-link active">
              <span class="nav-icon">üìÖ</span>
              Agendamentos
            </a>
          </li>
          <li class="nav-item">
            <a href="/evolutions.html" class="nav-link">
              <span class="nav-icon">üìù</span>
              Evolu√ß√µes
            </a>
          </li>
          <li class="nav-item">
            <a href="/facilities.html" class="nav-link">
              <span class="nav-icon">üè•</span>
              Unidades
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">üìä</span>
              Relat√≥rios
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">‚öôÔ∏è</span>
              Configura√ß√µes
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    
    <main class="main-content">
      <header class="header">
        <h1 class="page-title">Agendamentos</h1>
        <div class="user-menu">
          <div class="user-info">
            <div class="user-name" id="userName">Carregando...</div>
            <div class="user-role" id="userRole"></div>
          </div>
          <div class="avatar" id="userAvatar">U</div>
          <button class="logout-button" id="logoutButton">Sair</button>
        </div>
      </header>
      
      <div class="calendar-container">
        <div class="calendar-header">
          <h2 class="calendar-title" id="calendarTitle">Maio 2025</h2>
          
          <div class="calendar-controls">
            <div class="calendar-nav">
              <button class="calendar-button outline" id="prevButton">Anterior</button>
              <button class="calendar-button outline" id="todayButton">Hoje</button>
              <button class="calendar-button outline" id="nextButton">Pr√≥ximo</button>
            </div>
            
            <div class="calendar-view-buttons">
              <button class="calendar-view-button active" id="monthViewButton">M√™s</button>
              <button class="calendar-view-button" id="weekViewButton">Semana</button>
              <button class="calendar-view-button" id="listViewButton">Lista</button>
            </div>
            
            <button class="calendar-button" id="newAppointmentButton">Novo Agendamento</button>
          </div>
        </div>
        
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Profissional</label>
            <select class="filter-control" id="professionalFilter">
              <option value="">Todos</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Unidade</label>
            <select class="filter-control" id="facilityFilter">
              <option value="">Todas</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-control" id="statusFilter">
              <option value="">Todos</option>
              <option value="scheduled">Agendado</option>
              <option value="confirmed">Confirmado</option>
              <option value="completed">Conclu√≠do</option>
              <option value="cancelled">Cancelado</option>
              <option value="no_show">N√£o compareceu</option>
              <option value="pending">Pendente</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Tipo</label>
            <select class="filter-control" id="typeFilter">
              <option value="">Todos</option>
              <option value="psychology_aba">Psicologia - ABA</option>
              <option value="psychology_cbt">Psicologia - TCC</option>
              <option value="speech_therapy">Fonoaudiologia</option>
              <option value="physical_therapy">Fisioterapia</option>
              <option value="occupational_therapy">Terapia Ocupacional</option>
              <option value="evaluation">Avalia√ß√£o</option>
              <option value="other">Outro</option>
            </select>
          </div>
        </div>
        
        <div id="monthView" class="calendar">
          <div class="calendar-grid">
            <div class="calendar-weekday">Domingo</div>
            <div class="calendar-weekday">Segunda</div>
            <div class="calendar-weekday">Ter√ßa</div>
            <div class="calendar-weekday">Quarta</div>
            <div class="calendar-weekday">Quinta</div>
            <div class="calendar-weekday">Sexta</div>
            <div class="calendar-weekday">S√°bado</div>
            
            <!-- Calendar days will be inserted here by JavaScript -->
          </div>
        </div>
        
        <div id="weekView" class="weekly-calendar" style="display: none;">
          <div class="time-slots">
            <div class="time-labels">
              <div class="time-label">08:00</div>
              <div class="time-label">09:00</div>
              <div class="time-label">10:00</div>
              <div class="time-label">11:00</div>
              <div class="time-label">12:00</div>
              <div class="time-label">13:00</div>
              <div class="time-label">14:00</div>
              <div class="time-label">15:00</div>
              <div class="time-label">16:00</div>
              <div class="time-label">17:00</div>
              <div class="time-label">18:00</div>
              <div class="time-label">19:00</div>
              <div class="time-label">20:00</div>
              <div class="time-label">21:00</div>
              <div class="time-label">22:00</div>
              <div class="time-label">23:00</div>
            </div>
            
            <div class="weekly-days">
              <!-- Weekly days will be inserted here by JavaScript -->
            </div>
          </div>
        </div>
        
        <div id="listView" class="table-container" style="display: none;">
          <table>
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Paciente</th>
                <th>Profissional</th>
                <th>Tipo</th>
                <th>Unidade</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="appointmentsTableBody">
              <!-- Appointments list will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Modal Add/Edit Appointment -->
  <div class="modal-overlay" id="appointmentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Novo Agendamento</h3>
        <button class="close-button" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="appointmentForm">
          <input type="hidden" id="appointmentId">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="patientId">Paciente *</label>
              <select id="patientId" class="form-control" required>
                <option value="">Selecione o paciente</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="professionalId">Profissional *</label>
              <select id="professionalId" class="form-control" required>
                <option value="">Selecione o profissional</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="appointmentDate">Data *</label>
              <input type="date" id="appointmentDate" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="startTime">Hora de In√≠cio *</label>
              <input type="time" id="startTime" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="endTime">Hora de T√©rmino *</label>
              <input type="time" id="endTime" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="procedureType">Tipo de Procedimento *</label>
              <select id="procedureType" class="form-control" required>
                <option value="">Selecione</option>
                <option value="psychology_aba">Psicologia - ABA</option>
                <option value="psychology_cbt">Psicologia - TCC</option>
                <option value="speech_therapy">Fonoaudiologia</option>
                <option value="physical_therapy">Fisioterapia</option>
                <option value="occupational_therapy">Terapia Ocupacional</option>
                <option value="evaluation">Avalia√ß√£o</option>
                <option value="other">Outro</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="roomId">Sala *</label>
              <select id="roomId" class="form-control" required>
                <option value="">Selecione a sala</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" class="form-control">
                <option value="scheduled">Agendado</option>
                <option value="confirmed">Confirmado</option>
                <option value="completed">Conclu√≠do</option>
                <option value="cancelled">Cancelado</option>
                <option value="no_show">N√£o compareceu</option>
                <option value="pending">Pendente</option>
              </select>
            </div>
            
            <div class="form-group span-2">
              <label for="notes">Observa√ß√µes</label>
              <textarea id="notes" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="button button-outline" id="cancelButton">Cancelar</button>
        <button class="button button-primary" id="saveButton">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal View Appointment -->
  <div class="modal-overlay" id="viewAppointmentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes do Agendamento</h3>
        <button class="close-button" id="closeViewModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Paciente</div>
            <div class="detail-value" id="viewPatient"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Profissional</div>
            <div class="detail-value" id="viewProfessional"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Data</div>
            <div class="detail-value" id="viewDate"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Hor√°rio</div>
            <div class="detail-value" id="viewTime"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Tipo de Procedimento</div>
            <div class="detail-value" id="viewProcedureType"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Sala</div>
            <div class="detail-value" id="viewRoom"></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value" id="viewStatus"></div>
          </div>
          <div class="detail-item span-2">
            <div class="detail-label">Observa√ß√µes</div>
            <div class="detail-value" id="viewNotes"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-outline" id="editAppointmentButton">Editar</button>
        <button class="button button-primary" id="closeViewButton">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Verificar autentica√ß√£o e carregar dados do usu√°rio
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      setupEventListeners();
      
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      
      // Iniciar calend√°rio
      updateCalendarTitle();
      renderCalendar();
      
      // Carregar filtros
      loadProfessionals();
      loadFacilities();
      
      // Carregar agendamentos
      loadAppointments();
    });
    
    // Elementos DOM
    const userNameElement = document.getElementById('userName');
    const userRoleElement = document.getElementById('userRole');
    const userAvatarElement = document.getElementById('userAvatar');
    const logoutButton = document.getElementById('logoutButton');
    const calendarTitleElement = document.getElementById('calendarTitle');
    const prevButton = document.getElementById('prevButton');
    const todayButton = document.getElementById('todayButton');
    const nextButton = document.getElementById('nextButton');
    const monthViewButton = document.getElementById('monthViewButton');
    const weekViewButton = document.getElementById('weekViewButton');
    const listViewButton = document.getElementById('listViewButton');
    const monthViewElement = document.getElementById('monthView');
    const weekViewElement = document.getElementById('weekView');
    const listViewElement = document.getElementById('listView');
    const newAppointmentButton = document.getElementById('newAppointmentButton');
    const appointmentModal = document.getElementById('appointmentModal');
    const viewAppointmentModal = document.getElementById('viewAppointmentModal');
    const modalTitle = document.getElementById('modalTitle');
    const appointmentForm = document.getElementById('appointmentForm');
    const appointmentIdInput = document.getElementById('appointmentId');
    const closeModal = document.getElementById('closeModal');
    const closeViewModal = document.getElementById('closeViewModal');
    const cancelButton = document.getElementById('cancelButton');
    const saveButton = document.getElementById('saveButton');
    const closeViewButton = document.getElementById('closeViewButton');
    const editAppointmentButton = document.getElementById('editAppointmentButton');
    const professionalFilter = document.getElementById('professionalFilter');
    const facilityFilter = document.getElementById('facilityFilter');
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    
    // Vari√°veis globais para o calend√°rio
    let currentMonth;
    let currentYear;
    let appointments = [];
    let professionals = [];
    let patients = [];
    let facilities = [];
    let rooms = [];
    
    // Verificar autentica√ß√£o
    async function checkAuth() {
      try {
        const response = await fetch('/api/user', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          // N√£o autenticado, redirecionar para login
          window.location.href = '/login.html';
          return;
        }
        
        const userData = await response.json();
        displayUserData(userData);
      } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Exibir dados do usu√°rio
    function displayUserData(user) {
      userNameElement.textContent = user.fullName;
      userRoleElement.textContent = translateRole(user.role);
      
      // Iniciais do usu√°rio para o avatar
      const initials = user.fullName
        .split(' ')
        .map(name => name.charAt(0))
        .join('')
        .substring(0, 2)
        .toUpperCase();
      userAvatarElement.textContent = initials;
    }
    
    // Traduzir fun√ß√£o do ingl√™s para portugu√™s
    function translateRole(role) {
      const translations = {
        'admin': 'Administrador',
        'coordinator': 'Coordenador',
        'professional': 'Profissional',
        'intern': 'Estagi√°rio',
        'secretary': 'Secret√°rio(a)'
      };
      
      return translations[role] || role;
    }
    
    // Traduzir status
    function translateStatus(status) {
      const translations = {
        'scheduled': 'Agendado',
        'confirmed': 'Confirmado',
        'completed': 'Conclu√≠do',
        'cancelled': 'Cancelado',
        'no_show': 'N√£o compareceu',
        'pending': 'Pendente'
      };
      
      return translations[status] || status;
    }
    
    // Traduzir tipo de procedimento
    function translateProcedureType(type) {
      const translations = {
        'psychology_aba': 'Psicologia - ABA',
        'psychology_cbt': 'Psicologia - TCC',
        'speech_therapy': 'Fonoaudiologia',
        'physical_therapy': 'Fisioterapia',
        'occupational_therapy': 'Terapia Ocupacional',
        'evaluation': 'Avalia√ß√£o',
        'other': 'Outro',
        'free_time': 'Tempo Livre'
      };
      
      return translations[type] || type;
    }
    
    // Formatar data
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    }
    
    // Formatar hora
    function formatTime(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Formatar data e hora
    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Configurar event listeners
    function setupEventListeners() {
      // Logout
      logoutButton.addEventListener('click', logout);
      
      // Filtros
      professionalFilter.addEventListener('change', filterAppointments);
      facilityFilter.addEventListener('change', filterAppointments);
      statusFilter.addEventListener('change', filterAppointments);
      typeFilter.addEventListener('change', filterAppointments);
      
      // Navega√ß√£o do calend√°rio
      prevButton.addEventListener('click', previousMonth);
      todayButton.addEventListener('click', goToToday);
      nextButton.addEventListener('click', nextMonth);
      
      // Alternar visualiza√ß√µes
      monthViewButton.addEventListener('click', showMonthView);
      weekViewButton.addEventListener('click', showWeekView);
      listViewButton.addEventListener('click', showListView);
      
      // Novo agendamento
      newAppointmentButton.addEventListener('click', openNewAppointmentModal);
      
      // Fechar modal
      closeModal.addEventListener('click', closeAppointmentModal);
      closeViewModal.addEventListener('click', closeViewAppointmentModal);
      cancelButton.addEventListener('click', closeAppointmentModal);
      closeViewButton.addEventListener('click', closeViewAppointmentModal);
      
      // Modal de background
      appointmentModal.addEventListener('click', function(e) {
        if (e.target === appointmentModal) {
          closeAppointmentModal();
        }
      });
      
      viewAppointmentModal.addEventListener('click', function(e) {
        if (e.target === viewAppointmentModal) {
          closeViewAppointmentModal();
        }
      });
      
      // Salvar agendamento
      saveButton.addEventListener('click', saveAppointment);
      
      // Editar a partir da visualiza√ß√£o
      editAppointmentButton.addEventListener('click', function() {
        closeViewAppointmentModal();
        editAppointment(this.dataset.appointmentId);
      });
    }
    
    // Carregar profissionais
    async function loadProfessionals() {
      try {
        const response = await fetch('/api/professionals', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar profissionais');
        }
        
        professionals = await response.json();
        
        // Preencher select de filtro
        professionalFilter.innerHTML = '<option value="">Todos</option>';
        professionals.forEach(professional => {
          const option = document.createElement('option');
          option.value = professional.id;
          option.textContent = professional.user.fullName;
          professionalFilter.appendChild(option);
        });
        
        // Preencher select do formul√°rio
        const professionalIdSelect = document.getElementById('professionalId');
        professionalIdSelect.innerHTML = '<option value="">Selecione o profissional</option>';
        professionals.forEach(professional => {
          const option = document.createElement('option');
          option.value = professional.id;
          option.textContent = professional.user.fullName;
          professionalIdSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
      }
    }
    
    // Carregar unidades
    async function loadFacilities() {
      try {
        const response = await fetch('/api/facilities', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar unidades');
        }
        
        facilities = await response.json();
        
        // Preencher select de filtro
        facilityFilter.innerHTML = '<option value="">Todas</option>';
        facilities.forEach(facility => {
          const option = document.createElement('option');
          option.value = facility.id;
          option.textContent = facility.name;
          facilityFilter.appendChild(option);
        });
        
        // Carregar salas da primeira unidade por padr√£o
        if (facilities.length > 0) {
          loadRooms(facilities[0].id);
        }
      } catch (error) {
        console.error('Erro ao carregar unidades:', error);
      }
    }
    
    // Carregar salas
    async function loadRooms(facilityId) {
      try {
        const response = await fetch(`/api/facilities/${facilityId}/rooms`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar salas');
        }
        
        rooms = await response.json();
        
        // Preencher select do formul√°rio
        const roomIdSelect = document.getElementById('roomId');
        roomIdSelect.innerHTML = '<option value="">Selecione a sala</option>';
        rooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room.id;
          option.textContent = room.name;
          roomIdSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar salas:', error);
      }
    }
    
    // Carregar pacientes
    async function loadPatients() {
      try {
        const response = await fetch('/api/patients', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar pacientes');
        }
        
        patients = await response.json();
        
        // Preencher select do formul√°rio
        const patientIdSelect = document.getElementById('patientId');
        patientIdSelect.innerHTML = '<option value="">Selecione o paciente</option>';
        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.id;
          option.textContent = patient.fullName;
          patientIdSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar pacientes:', error);
      }
    }
    
    // Carregar agendamentos
    async function loadAppointments() {
      try {
        const url = new URL('/api/appointments', window.location.origin);
        
        // Adicionar par√¢metros de data
        const startDate = new Date(currentYear, currentMonth, 1);
        const endDate = new Date(currentYear, currentMonth + 1, 0);
        
        url.searchParams.append('startDate', startDate.toISOString().split('T')[0]);
        url.searchParams.append('endDate', endDate.toISOString().split('T')[0]);
        
        // Adicionar filtros
        if (professionalFilter.value) {
          url.searchParams.append('professionalId', professionalFilter.value);
        }
        
        if (facilityFilter.value) {
          url.searchParams.append('facilityId', facilityFilter.value);
        }
        
        if (statusFilter.value) {
          url.searchParams.append('status', statusFilter.value);
        }
        
        if (typeFilter.value) {
          url.searchParams.append('procedureType', typeFilter.value);
        }
        
        const response = await fetch(url, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar agendamentos');
        }
        
        appointments = await response.json();
        
        // Renderizar calend√°rio com os agendamentos
        renderCalendar();
        renderListView();
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
      }
    }
    
    // Filtrar agendamentos
    function filterAppointments() {
      loadAppointments();
    }
    
    // Atualizar t√≠tulo do calend√°rio
    function updateCalendarTitle() {
      const monthNames = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      
      calendarTitleElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    }
    
    // Renderizar calend√°rio
    function renderCalendar() {
      const calendarGrid = document.querySelector('.calendar-grid');
      const daysContainer = document.createElement('div');
      daysContainer.className = 'calendar-days';
      
      // Remover os dias existentes (exceto cabe√ßalhos)
      const existingDays = calendarGrid.querySelectorAll('.calendar-day');
      existingDays.forEach(day => day.remove());
      
      // Obter o primeiro dia do m√™s
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      
      // Obter o dia da semana do primeiro dia (0 = Domingo, 1 = Segunda, etc.)
      const firstDayOfWeek = firstDay.getDay();
      
      // Obter o n√∫mero de dias no m√™s
      const daysInMonth = lastDay.getDate();
      
      // Obter o √∫ltimo dia do m√™s anterior
      const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
      
      // Dia atual
      const today = new Date();
      const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
      
      // Dias do m√™s anterior
      for (let i = 0; i < firstDayOfWeek; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        
        const dayNumber = prevMonthLastDay - firstDayOfWeek + i + 1;
        day.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;
        
        calendarGrid.appendChild(day);
      }
      
      // Dias do m√™s atual
      for (let i = 1; i <= daysInMonth; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day';
        
        // Se for hoje
        if (isCurrentMonth && i === today.getDate()) {
          day.classList.add('today');
        }
        
        day.innerHTML = `<div class="calendar-day-number">${i}</div>`;
        
        // Adicionar agendamentos para este dia
        const date = new Date(currentYear, currentMonth, i);
        const dateString = date.toISOString().split('T')[0];
        
        const dayAppointments = appointments.filter(appointment => {
          const appointmentDate = new Date(appointment.startTime);
          return appointmentDate.toISOString().split('T')[0] === dateString;
        });
        
        dayAppointments.forEach(appointment => {
          const appointmentElement = document.createElement('div');
          appointmentElement.className = `appointment ${appointment.status}`;
          
          const startTime = new Date(appointment.startTime);
          const timeString = startTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          
          // Encontrar dados relacionados
          const patient = patients.find(p => p.id === appointment.patientId);
          const professional = professionals.find(p => p.id === appointment.professionalId);
          
          appointmentElement.textContent = `${timeString} - ${patient ? patient.fullName : 'Paciente'} (${translateProcedureType(appointment.procedureType)})`;
          appointmentElement.title = `${timeString} - ${patient ? patient.fullName : 'Paciente'} com ${professional ? professional.user.fullName : 'Profissional'}`;
          
          // Adicionar evento de clique
          appointmentElement.dataset.id = appointment.id;
          appointmentElement.addEventListener('click', () => viewAppointment(appointment.id));
          
          day.appendChild(appointmentElement);
        });
        
        calendarGrid.appendChild(day);
      }
      
      // Preencher o resto da grade com dias do pr√≥ximo m√™s
      const totalDaysDisplayed = firstDayOfWeek + daysInMonth;
      const remainingDays = 42 - totalDaysDisplayed; // 6 linhas * 7 dias
      
      for (let i = 1; i <= remainingDays; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        day.innerHTML = `<div class="calendar-day-number">${i}</div>`;
        calendarGrid.appendChild(day);
      }
    }
    
    // Renderizar visualiza√ß√£o em lista
    function renderListView() {
      const tbody = document.getElementById('appointmentsTableBody');
      tbody.innerHTML = '';
      
      if (appointments.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="7">
            <div class="empty-state">
              <div class="empty-icon">üìÖ</div>
              <div class="empty-text">Nenhum agendamento encontrado para o per√≠odo selecionado.</div>
              <button class="button button-primary" id="emptyNewAppointmentBtn">Novo Agendamento</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
        
        document.getElementById('emptyNewAppointmentBtn')?.addEventListener('click', openNewAppointmentModal);
        return;
      }
      
      // Ordenar agendamentos por data
      const sortedAppointments = [...appointments].sort((a, b) => {
        return new Date(a.startTime) - new Date(b.startTime);
      });
      
      sortedAppointments.forEach(appointment => {
        const row = document.createElement('tr');
        
        // Encontrar dados relacionados
        const patient = patients.find(p => p.id === appointment.patientId);
        const professional = professionals.find(p => p.id === appointment.professionalId);
        const room = rooms.find(r => r.id === appointment.roomId);
        
        row.innerHTML = `
          <td>${formatDateTime(appointment.startTime)}</td>
          <td>${patient ? patient.fullName : 'N/A'}</td>
          <td>${professional ? professional.user.fullName : 'N/A'}</td>
          <td>${translateProcedureType(appointment.procedureType)}</td>
          <td>${room ? room.name : 'N/A'}</td>
          <td><span class="status status-${appointment.status}">${translateStatus(appointment.status)}</span></td>
          <td>
            <button class="action-button view-appointment" data-id="${appointment.id}">Visualizar</button>
            <button class="action-button edit-appointment" data-id="${appointment.id}">Editar</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Adicionar event listeners
      document.querySelectorAll('.view-appointment').forEach(button => {
        button.addEventListener('click', () => viewAppointment(button.dataset.id));
      });
      
      document.querySelectorAll('.edit-appointment').forEach(button => {
        button.addEventListener('click', () => editAppointment(button.dataset.id));
      });
    }
    
    // Navegar para o m√™s anterior
    function previousMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateCalendarTitle();
      loadAppointments();
    }
    
    // Navegar para o m√™s atual
    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      updateCalendarTitle();
      loadAppointments();
    }
    
    // Navegar para o pr√≥ximo m√™s
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateCalendarTitle();
      loadAppointments();
    }
    
    // Mostrar visualiza√ß√£o de m√™s
    function showMonthView() {
      monthViewButton.classList.add('active');
      weekViewButton.classList.remove('active');
      listViewButton.classList.remove('active');
      
      monthViewElement.style.display = 'block';
      weekViewElement.style.display = 'none';
      listViewElement.style.display = 'none';
    }
    
    // Mostrar visualiza√ß√£o de semana
    function showWeekView() {
      monthViewButton.classList.remove('active');
      weekViewButton.classList.add('active');
      listViewButton.classList.remove('active');
      
      monthViewElement.style.display = 'none';
      weekViewElement.style.display = 'block';
      listViewElement.style.display = 'none';
      
      // Implementar visualiza√ß√£o da semana (simplificado)
      alert('Visualiza√ß√£o de semana ser√° implementada em breve.');
      showMonthView(); // Voltar para visualiza√ß√£o de m√™s por enquanto
    }
    
    // Mostrar visualiza√ß√£o de lista
    function showListView() {
      monthViewButton.classList.remove('active');
      weekViewButton.classList.remove('active');
      listViewButton.classList.add('active');
      
      monthViewElement.style.display = 'none';
      weekViewElement.style.display = 'none';
      listViewElement.style.display = 'block';
    }
    
    // Abrir modal para novo agendamento
    function openNewAppointmentModal() {
      modalTitle.textContent = 'Novo Agendamento';
      appointmentForm.reset();
      appointmentIdInput.value = '';
      
      // Carregar dados necess√°rios
      if (patients.length === 0) loadPatients();
      if (professionals.length === 0) loadProfessionals();
      if (facilities.length > 0 && rooms.length === 0) loadRooms(facilities[0].id);
      
      // Definir status padr√£o como "Agendado"
      document.getElementById('status').value = 'scheduled';
      
      // Definir data padr√£o como hoje
      const today = new Date();
      const dateString = today.toISOString().split('T')[0];
      document.getElementById('appointmentDate').value = dateString;
      
      appointmentModal.classList.add('active');
    }
    
    // Fechar modal de agendamento
    function closeAppointmentModal() {
      appointmentModal.classList.remove('active');
    }
    
    // Fechar modal de visualiza√ß√£o
    function closeViewAppointmentModal() {
      viewAppointmentModal.classList.remove('active');
    }
    
    // Editar agendamento
    async function editAppointment(appointmentId) {
      try {
        modalTitle.textContent = 'Editar Agendamento';
        
        // Carregar dados necess√°rios
        if (patients.length === 0) await loadPatients();
        if (professionals.length === 0) await loadProfessionals();
        if (facilities.length > 0 && rooms.length === 0) await loadRooms(facilities[0].id);
        
        const appointment = appointments.find(a => a.id == appointmentId);
        
        if (!appointment) {
          // Se n√£o encontrar no cache, buscar do servidor
          const response = await fetch(`/api/appointments/${appointmentId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao carregar dados do agendamento');
          }
          
          const appointmentData = await response.json();
          fillAppointmentForm(appointmentData);
        } else {
          fillAppointmentForm(appointment);
        }
        
        appointmentModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao editar agendamento:', error);
        alert('Erro ao carregar dados do agendamento. Tente novamente.');
      }
    }
    
    // Preencher formul√°rio com dados do agendamento
    function fillAppointmentForm(appointment) {
      appointmentIdInput.value = appointment.id;
      document.getElementById('patientId').value = appointment.patientId || '';
      document.getElementById('professionalId').value = appointment.professionalId || '';
      
      // Data e hora
      const startTime = new Date(appointment.startTime);
      const endTime = new Date(appointment.endTime);
      
      document.getElementById('appointmentDate').value = startTime.toISOString().split('T')[0];
      document.getElementById('startTime').value = startTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('endTime').value = endTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      
      document.getElementById('procedureType').value = appointment.procedureType || '';
      document.getElementById('roomId').value = appointment.roomId || '';
      document.getElementById('status').value = appointment.status || 'scheduled';
      document.getElementById('notes').value = appointment.notes || '';
    }
    
    // Visualizar agendamento
    async function viewAppointment(appointmentId) {
      try {
        // Carregar dados necess√°rios
        if (patients.length === 0) await loadPatients();
        if (professionals.length === 0) await loadProfessionals();
        
        const appointment = appointments.find(a => a.id == appointmentId);
        
        if (!appointment) {
          // Se n√£o encontrar no cache, buscar do servidor
          const response = await fetch(`/api/appointments/${appointmentId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao carregar dados do agendamento');
          }
          
          const appointmentData = await response.json();
          displayAppointmentDetails(appointmentData);
        } else {
          displayAppointmentDetails(appointment);
        }
        
        // Configurar bot√£o de edi√ß√£o
        editAppointmentButton.dataset.appointmentId = appointmentId;
        
        viewAppointmentModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao visualizar agendamento:', error);
        alert('Erro ao carregar dados do agendamento. Tente novamente.');
      }
    }
    
    // Exibir detalhes do agendamento
    function displayAppointmentDetails(appointment) {
      // Encontrar dados relacionados
      const patient = patients.find(p => p.id === appointment.patientId);
      const professional = professionals.find(p => p.id === appointment.professionalId);
      const room = rooms.find(r => r.id === appointment.roomId);
      
      document.getElementById('viewPatient').textContent = patient ? patient.fullName : 'N/A';
      document.getElementById('viewProfessional').textContent = professional ? professional.user.fullName : 'N/A';
      
      // Data e hora
      const startTime = new Date(appointment.startTime);
      const endTime = new Date(appointment.endTime);
      
      document.getElementById('viewDate').textContent = formatDate(appointment.startTime);
      document.getElementById('viewTime').textContent = `${formatTime(appointment.startTime)} at√© ${formatTime(appointment.endTime)}`;
      
      document.getElementById('viewProcedureType').textContent = translateProcedureType(appointment.procedureType);
      document.getElementById('viewRoom').textContent = room ? room.name : 'N/A';
      
      const statusElement = document.getElementById('viewStatus');
      statusElement.textContent = translateStatus(appointment.status);
      statusElement.className = `status status-${appointment.status}`;
      
      document.getElementById('viewNotes').textContent = appointment.notes || 'Nenhuma observa√ß√£o';
    }
    
    // Salvar agendamento
    async function saveAppointment() {
      try {
        // Valida√ß√£o b√°sica
        const patientId = document.getElementById('patientId').value;
        const professionalId = document.getElementById('professionalId').value;
        const appointmentDate = document.getElementById('appointmentDate').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const procedureType = document.getElementById('procedureType').value;
        const roomId = document.getElementById('roomId').value;
        
        if (!patientId || !professionalId || !appointmentDate || !startTime || !endTime || !procedureType || !roomId) {
          alert('Por favor, preencha todos os campos obrigat√≥rios.');
          return;
        }
        
        // Construir datas ISO
        const startDateTime = new Date(`${appointmentDate}T${startTime}`);
        const endDateTime = new Date(`${appointmentDate}T${endTime}`);
        
        // Verificar se a data de t√©rmino √© posterior √† data de in√≠cio
        if (endDateTime <= startDateTime) {
          alert('A hora de t√©rmino deve ser posterior √† hora de in√≠cio.');
          return;
        }
        
        // Preparar dados do agendamento
        const appointmentData = {
          patientId: parseInt(patientId),
          professionalId: parseInt(professionalId),
          startTime: startDateTime.toISOString(),
          endTime: endDateTime.toISOString(),
          procedureType,
          roomId: parseInt(roomId),
          status: document.getElementById('status').value,
          notes: document.getElementById('notes').value
        };
        
        const appointmentId = appointmentIdInput.value;
        let response;
        
        if (appointmentId) {
          // Editar agendamento existente
          response = await fetch(`/api/appointments/${appointmentId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(appointmentData)
          });
        } else {
          // Adicionar novo agendamento
          response = await fetch('/api/appointments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(appointmentData)
          });
        }
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao salvar agendamento');
        }
        
        // Fechar modal e recarregar lista
        closeAppointmentModal();
        loadAppointments();
        
        alert(appointmentId ? 'Agendamento atualizado com sucesso!' : 'Agendamento adicionado com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar agendamento:', error);
        alert(`Erro ao salvar agendamento: ${error.message}`);
      }
    }
    
    // Logout
    async function logout() {
      try {
        await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao fazer logout. Tente novamente.');
      }
    }
  </script>
</body>
</html>