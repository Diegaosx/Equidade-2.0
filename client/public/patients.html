<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pacientes - Cl√≠nica Equidade</title>
  <style>
    :root {
      --primary: #4b6cb7;
      --primary-dark: #3a5a9c;
      --secondary: #182848;
      --text-main: #333;
      --text-light: #666;
      --bg-light: #f5f7fa;
      --bg-white: #ffffff;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e5e7eb;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      line-height: 1.5;
    }
    
    .layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background-color: var(--secondary);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 10;
    }
    
    .logo {
      padding: 0 20px 20px;
      font-size: 24px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    
    .nav-list {
      list-style: none;
    }
    
    .nav-item {
      margin-bottom: 5px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .nav-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 20px;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background-color: var(--bg-white);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 600;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
    }
    
    .user-info {
      margin-right: 15px;
      text-align: right;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      color: var(--text-light);
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .logout-button {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 15px;
    }
    
    .logout-button:hover {
      background-color: #dc2626;
    }
    
    /* Table */
    .table-container {
      background-color: var(--bg-white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
      margin-bottom: 30px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      color: var(--text-light);
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-active {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-inactive {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .action-button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .action-button.delete {
      color: var(--danger);
    }
    
    /* Button */
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .button-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .button-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .button-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .button-outline:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    /* Search input */
    .search-container {
      position: relative;
      width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.span-2 {
      grid-column: span 2;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    .form-text {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    .error-message {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    
    .checkbox-group input {
      margin-right: 8px;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      list-style: none;
    }
    
    .pagination li {
      margin: 0 4px;
    }
    
    .pagination a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      text-decoration: none;
      color: var(--text-main);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .pagination a:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    .pagination a.active {
      background-color: var(--primary);
      color: white;
    }
    
    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    
    .empty-icon {
      font-size: 48px;
      color: var(--text-light);
      margin-bottom: 16px;
    }
    
    .empty-text {
      font-size: 16px;
      color: var(--text-light);
      margin-bottom: 24px;
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: var(--text-main);
      color: white;
      text-align: center;
      border-radius: 4px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* Patient details box */
    .patient-details {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .patient-header {
      padding: 20px;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
    }
    
    .patient-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: white;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 600;
      margin-right: 20px;
    }
    
    .patient-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .patient-subtitle {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .patient-body {
      padding: 20px;
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .detail-item {
      margin-bottom: 15px;
    }
    
    .detail-label {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-menu {
        margin-top: 15px;
        width: 100%;
        justify-content: space-between;
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .search-container {
        width: 100%;
        margin-top: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group.span-2 {
        grid-column: span 1;
      }
      
      .patient-header {
        flex-direction: column;
        text-align: center;
      }
      
      .patient-avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">Cl√≠nica Equidade</div>
      <nav>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/dashboard.html" class="nav-link">
              <span class="nav-icon">üìä</span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="/patients.html" class="nav-link active">
              <span class="nav-icon">üë•</span>
              Pacientes
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">üë®‚Äç‚öïÔ∏è</span>
              Profissionais
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">üìÖ</span>
              Agendamentos
            </a>
          </li>
          <li class="nav-item">
            <a href="/evolutions.html" class="nav-link">
              <span class="nav-icon">üìù</span>
              Evolu√ß√µes
            </a>
          </li>
          <li class="nav-item">
            <a href="/facilities.html" class="nav-link">
              <span class="nav-icon">üè•</span>
              Unidades
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">üìä</span>
              Relat√≥rios
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">‚öôÔ∏è</span>
              Configura√ß√µes
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    
    <main class="main-content">
      <header class="header">
        <h1 class="page-title">Pacientes</h1>
        <div class="user-menu">
          <div class="user-info">
            <div class="user-name" id="userName">Carregando...</div>
            <div class="user-role" id="userRole"></div>
          </div>
          <div class="avatar" id="userAvatar">U</div>
          <button class="logout-button" id="logoutButton">Sair</button>
        </div>
      </header>
      
      <div class="table-container">
        <div class="table-header">
          <h2 class="card-title">Lista de Pacientes</h2>
          <div class="actions">
            <div class="search-container">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="searchPatient" placeholder="Pesquisar por nome...">
            </div>
          </div>
        </div>
        
        <button class="button button-primary" id="addPatientBtn" style="margin-bottom: 20px;">
          ‚ûï Adicionar Paciente
        </button>
        
        <table id="patientsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Data de Nascimento</th>
              <th>CPF</th>
              <th>Telefone</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="patientsTableBody">
            <tr>
              <td colspan="6" class="text-center">Carregando pacientes...</td>
            </tr>
          </tbody>
        </table>
        
        <ul class="pagination" id="pagination">
          <!-- Pagination will be generated by JavaScript -->
        </ul>
      </div>
    </main>
  </div>
  
  <!-- Modal Add/Edit Patient -->
  <div class="modal-overlay" id="patientModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Adicionar Paciente</h3>
        <button class="close-button" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="patientForm">
          <input type="hidden" id="patientId">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="fullName">Nome Completo *</label>
              <input type="text" id="fullName" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="dateOfBirth">Data de Nascimento *</label>
              <input type="date" id="dateOfBirth" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="cpf">CPF *</label>
              <input type="text" id="cpf" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="rg">RG</label>
              <input type="text" id="rg" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="gender">G√™nero</label>
              <select id="gender" class="form-control">
                <option value="">Selecione</option>
                <option value="male">Masculino</option>
                <option value="female">Feminino</option>
                <option value="other">Outro</option>
                <option value="not_inform">N√£o informar</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="phone">Telefone *</label>
              <input type="tel" id="phone" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="email">E-mail</label>
              <input type="email" id="email" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="emergencyContact">Contato de Emerg√™ncia</label>
              <input type="text" id="emergencyContact" class="form-control">
            </div>
            
            <div class="form-group span-2">
              <label for="address">Endere√ßo</label>
              <input type="text" id="address" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="city">Cidade</label>
              <input type="text" id="city" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="state">Estado</label>
              <input type="text" id="state" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="zipCode">CEP</label>
              <input type="text" id="zipCode" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="insurancePlanId">Plano de Sa√∫de</label>
              <select id="insurancePlanId" class="form-control">
                <option value="">Selecione</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="insuranceNumber">N√∫mero do Plano</label>
              <input type="text" id="insuranceNumber" class="form-control">
            </div>
            
            <div class="form-group">
              <label for="insuranceExpirationDate">Validade do Plano</label>
              <input type="date" id="insuranceExpirationDate" class="form-control">
            </div>
            
            <div class="form-group span-2">
              <label for="healthConditions">Condi√ß√µes de Sa√∫de</label>
              <textarea id="healthConditions" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group span-2">
              <label for="allergies">Alergias</label>
              <textarea id="allergies" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group span-2">
              <label for="medications">Medica√ß√µes</label>
              <textarea id="medications" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="form-group span-2">
              <label for="notes">Observa√ß√µes</label>
              <textarea id="notes" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="isActive" checked>
                <label for="isActive">Paciente ativo</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="button button-outline" id="cancelButton">Cancelar</button>
        <button class="button button-primary" id="saveButton">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal View Patient -->
  <div class="modal-overlay" id="viewPatientModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes do Paciente</h3>
        <button class="close-button" id="closeViewModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="patient-header">
          <div class="patient-avatar" id="patientViewAvatar">MS</div>
          <div>
            <h2 class="patient-name" id="patientViewName">Carregando...</h2>
            <div class="patient-subtitle" id="patientViewAge"></div>
          </div>
        </div>
        
        <div class="patient-body">
          <h3 class="section-title">Informa√ß√µes Pessoais</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">CPF</div>
              <div class="detail-value" id="patientViewCpf"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">RG</div>
              <div class="detail-value" id="patientViewRg"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Data de Nascimento</div>
              <div class="detail-value" id="patientViewDob"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">G√™nero</div>
              <div class="detail-value" id="patientViewGender"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Telefone</div>
              <div class="detail-value" id="patientViewPhone"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">E-mail</div>
              <div class="detail-value" id="patientViewEmail"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Contato de Emerg√™ncia</div>
              <div class="detail-value" id="patientViewEmergency"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value" id="patientViewStatus"></div>
            </div>
          </div>
          
          <h3 class="section-title">Endere√ßo</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Endere√ßo Completo</div>
              <div class="detail-value" id="patientViewAddress"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Cidade</div>
              <div class="detail-value" id="patientViewCity"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Estado</div>
              <div class="detail-value" id="patientViewState"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">CEP</div>
              <div class="detail-value" id="patientViewZip"></div>
            </div>
          </div>
          
          <h3 class="section-title">Plano de Sa√∫de</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Plano</div>
              <div class="detail-value" id="patientViewPlan"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">N√∫mero</div>
              <div class="detail-value" id="patientViewPlanNumber"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Validade</div>
              <div class="detail-value" id="patientViewPlanExpiration"></div>
            </div>
          </div>
          
          <h3 class="section-title">Sa√∫de</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Condi√ß√µes de Sa√∫de</div>
              <div class="detail-value" id="patientViewHealth"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Alergias</div>
              <div class="detail-value" id="patientViewAllergies"></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Medica√ß√µes</div>
              <div class="detail-value" id="patientViewMedications"></div>
            </div>
          </div>
          
          <h3 class="section-title">Observa√ß√µes</h3>
          <div class="detail-value" id="patientViewNotes"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-outline" id="editFromViewButton">Editar</button>
        <button class="button button-primary" id="closeViewButton">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Verificar autentica√ß√£o e carregar dados do usu√°rio
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadPatients();
      loadInsurancePlans();
      setupEventListeners();
    });
    
    // Elementos DOM
    const userNameElement = document.getElementById('userName');
    const userRoleElement = document.getElementById('userRole');
    const userAvatarElement = document.getElementById('userAvatar');
    const logoutButton = document.getElementById('logoutButton');
    const patientsTableBody = document.getElementById('patientsTableBody');
    const searchPatientInput = document.getElementById('searchPatient');
    const addPatientBtn = document.getElementById('addPatientBtn');
    const patientModal = document.getElementById('patientModal');
    const viewPatientModal = document.getElementById('viewPatientModal');
    const modalTitle = document.getElementById('modalTitle');
    const patientForm = document.getElementById('patientForm');
    const patientIdInput = document.getElementById('patientId');
    const closeModal = document.getElementById('closeModal');
    const closeViewModal = document.getElementById('closeViewModal');
    const cancelButton = document.getElementById('cancelButton');
    const saveButton = document.getElementById('saveButton');
    const closeViewButton = document.getElementById('closeViewButton');
    const editFromViewButton = document.getElementById('editFromViewButton');
    const paginationElement = document.getElementById('pagination');
    
    // Configura√ß√£o de pagina√ß√£o
    let currentPage = 1;
    const pageSize = 10;
    let totalPages = 1;
    let patients = [];
    let filteredPatients = [];
    let insurancePlans = [];
    
    // Verificar autentica√ß√£o
    async function checkAuth() {
      try {
        const response = await fetch('/api/user', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          // N√£o autenticado, redirecionar para login
          window.location.href = '/login.html';
          return;
        }
        
        const userData = await response.json();
        displayUserData(userData);
      } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Exibir dados do usu√°rio
    function displayUserData(user) {
      userNameElement.textContent = user.fullName;
      userRoleElement.textContent = translateRole(user.role);
      
      // Iniciais do usu√°rio para o avatar
      const initials = user.fullName
        .split(' ')
        .map(name => name.charAt(0))
        .join('')
        .substring(0, 2)
        .toUpperCase();
      userAvatarElement.textContent = initials;
    }
    
    // Traduzir fun√ß√£o do ingl√™s para portugu√™s
    function translateRole(role) {
      const translations = {
        'admin': 'Administrador',
        'coordinator': 'Coordenador',
        'professional': 'Profissional',
        'intern': 'Estagi√°rio',
        'secretary': 'Secret√°rio(a)'
      };
      
      return translations[role] || role;
    }
    
    // Traduzir g√™nero do ingl√™s para portugu√™s
    function translateGender(gender) {
      const translations = {
        'male': 'Masculino',
        'female': 'Feminino',
        'other': 'Outro',
        'not_inform': 'N√£o informado'
      };
      
      return translations[gender] || 'N√£o informado';
    }
    
    // Formatar data
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    }
    
    // Calcular idade a partir da data de nascimento
    function calculateAge(birthDateString) {
      if (!birthDateString) return '';
      
      const birthDate = new Date(birthDateString);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      
      return `${age} anos`;
    }
    
    // Carregar lista de pacientes
    async function loadPatients(searchTerm = '') {
      try {
        let url = '/api/patients';
        if (searchTerm) {
          url += `?search=${encodeURIComponent(searchTerm)}`;
        }
        
        const response = await fetch(url, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar pacientes');
        }
        
        patients = await response.json();
        filteredPatients = [...patients];
        
        // Aplicar filtragem se houver termo de pesquisa
        if (searchTerm) {
          filteredPatients = patients.filter(patient => 
            patient.fullName.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        // Calcular n√∫mero total de p√°ginas
        totalPages = Math.ceil(filteredPatients.length / pageSize);
        
        // Renderizar tabela e pagina√ß√£o
        renderPatientsTable();
        renderPagination();
      } catch (error) {
        console.error('Erro ao carregar pacientes:', error);
        patientsTableBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-icon">‚ùå</div>
                <div class="empty-text">Erro ao carregar pacientes. Tente novamente.</div>
                <button class="button button-primary" onclick="loadPatients()">Tentar novamente</button>
              </div>
            </td>
          </tr>
        `;
      }
    }
    
    // Renderizar tabela de pacientes
    function renderPatientsTable() {
      // Se n√£o h√° pacientes
      if (filteredPatients.length === 0) {
        patientsTableBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-icon">üë•</div>
                <div class="empty-text">Nenhum paciente encontrado.</div>
                <button class="button button-primary" id="emptyAddPatientBtn">Adicionar Paciente</button>
              </div>
            </td>
          </tr>
        `;
        
        document.getElementById('emptyAddPatientBtn')?.addEventListener('click', openAddPatientModal);
        return;
      }
      
      // Calcular √≠ndices para pagina√ß√£o
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredPatients.length);
      const patientsToShow = filteredPatients.slice(startIndex, endIndex);
      
      // Limpar tabela
      patientsTableBody.innerHTML = '';
      
      // Adicionar linhas
      patientsToShow.forEach(patient => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${patient.fullName}</td>
          <td>${formatDate(patient.dateOfBirth)}</td>
          <td>${patient.cpf || 'N/A'}</td>
          <td>${patient.phone || 'N/A'}</td>
          <td>
            <span class="status ${patient.isActive ? 'status-active' : 'status-inactive'}">
              ${patient.isActive ? 'Ativo' : 'Inativo'}
            </span>
          </td>
          <td>
            <button class="action-button view-patient" data-id="${patient.id}">Visualizar</button>
            <button class="action-button edit-patient" data-id="${patient.id}">Editar</button>
          </td>
        `;
        
        patientsTableBody.appendChild(row);
      });
      
      // Adicionar event listeners
      document.querySelectorAll('.view-patient').forEach(button => {
        button.addEventListener('click', () => viewPatient(button.dataset.id));
      });
      
      document.querySelectorAll('.edit-patient').forEach(button => {
        button.addEventListener('click', () => editPatient(button.dataset.id));
      });
    }
    
    // Renderizar pagina√ß√£o
    function renderPagination() {
      if (totalPages <= 1) {
        paginationElement.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Bot√£o anterior
      paginationHTML += `
        <li>
          <a href="#" class="${currentPage === 1 ? 'disabled' : ''}" 
             onclick="${currentPage > 1 ? 'changePage(' + (currentPage - 1) + ')' : 'return false'}">
            &laquo;
          </a>
        </li>
      `;
      
      // P√°ginas num√©ricas
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li>
            <a href="#" class="${i === currentPage ? 'active' : ''}" 
               onclick="changePage(${i})">
              ${i}
            </a>
          </li>
        `;
      }
      
      // Bot√£o pr√≥ximo
      paginationHTML += `
        <li>
          <a href="#" class="${currentPage === totalPages ? 'disabled' : ''}" 
             onclick="${currentPage < totalPages ? 'changePage(' + (currentPage + 1) + ')' : 'return false'}">
            &raquo;
          </a>
        </li>
      `;
      
      paginationElement.innerHTML = paginationHTML;
    }
    
    // Mudar p√°gina
    function changePage(page) {
      currentPage = page;
      renderPatientsTable();
      renderPagination();
      return false; // Prevenir comportamento padr√£o do link
    }
    
    // Carregar planos de sa√∫de
    async function loadInsurancePlans() {
      try {
        const response = await fetch('/api/insurance-plans', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar planos de sa√∫de');
        }
        
        insurancePlans = await response.json();
        const insurancePlanSelect = document.getElementById('insurancePlanId');
        
        // Limpar select
        insurancePlanSelect.innerHTML = '<option value="">Selecione</option>';
        
        // Adicionar op√ß√µes
        insurancePlans.forEach(plan => {
          const option = document.createElement('option');
          option.value = plan.id;
          option.textContent = plan.name;
          insurancePlanSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar planos de sa√∫de:', error);
      }
    }
    
    // Configurar event listeners
    function setupEventListeners() {
      // Logout
      logoutButton.addEventListener('click', logout);
      
      // Pesquisa
      searchPatientInput.addEventListener('input', debounce(function() {
        currentPage = 1; // Voltar para a primeira p√°gina ao pesquisar
        loadPatients(this.value);
      }, 500));
      
      // Adicionar paciente
      addPatientBtn.addEventListener('click', openAddPatientModal);
      
      // Fechar modal
      closeModal.addEventListener('click', closePatientModal);
      closeViewModal.addEventListener('click', closeViewPatientModal);
      cancelButton.addEventListener('click', closePatientModal);
      closeViewButton.addEventListener('click', closeViewPatientModal);
      
      // Modal de background
      patientModal.addEventListener('click', function(e) {
        if (e.target === patientModal) {
          closePatientModal();
        }
      });
      
      viewPatientModal.addEventListener('click', function(e) {
        if (e.target === viewPatientModal) {
          closeViewPatientModal();
        }
      });
      
      // Salvar paciente
      saveButton.addEventListener('click', savePatient);
      
      // Editar a partir da visualiza√ß√£o
      editFromViewButton.addEventListener('click', function() {
        closeViewPatientModal();
        editPatient(this.dataset.patientId);
      });
    }
    
    // Abrir modal para adicionar paciente
    function openAddPatientModal() {
      modalTitle.textContent = 'Adicionar Paciente';
      patientForm.reset();
      patientIdInput.value = '';
      document.getElementById('isActive').checked = true;
      
      patientModal.classList.add('active');
    }
    
    // Editar paciente
    async function editPatient(patientId) {
      try {
        modalTitle.textContent = 'Editar Paciente';
        
        const patient = patients.find(p => p.id == patientId);
        
        if (!patient) {
          // Se n√£o encontrar no cache, buscar do servidor
          const response = await fetch(`/api/patients/${patientId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao carregar dados do paciente');
          }
          
          const patientData = await response.json();
          fillPatientForm(patientData);
        } else {
          fillPatientForm(patient);
        }
        
        patientModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao editar paciente:', error);
        alert('Erro ao carregar dados do paciente. Tente novamente.');
      }
    }
    
    // Preencher formul√°rio com dados do paciente
    function fillPatientForm(patient) {
      patientIdInput.value = patient.id;
      document.getElementById('fullName').value = patient.fullName || '';
      document.getElementById('dateOfBirth').value = patient.dateOfBirth ? new Date(patient.dateOfBirth).toISOString().split('T')[0] : '';
      document.getElementById('cpf').value = patient.cpf || '';
      document.getElementById('rg').value = patient.rg || '';
      document.getElementById('gender').value = patient.gender || '';
      document.getElementById('phone').value = patient.phone || '';
      document.getElementById('email').value = patient.email || '';
      document.getElementById('emergencyContact').value = patient.emergencyContact || '';
      document.getElementById('address').value = patient.address || '';
      document.getElementById('city').value = patient.city || '';
      document.getElementById('state').value = patient.state || '';
      document.getElementById('zipCode').value = patient.zipCode || '';
      document.getElementById('insurancePlanId').value = patient.insurancePlanId || '';
      document.getElementById('insuranceNumber').value = patient.insuranceNumber || '';
      document.getElementById('insuranceExpirationDate').value = patient.insuranceExpirationDate ? new Date(patient.insuranceExpirationDate).toISOString().split('T')[0] : '';
      document.getElementById('healthConditions').value = patient.healthConditions || '';
      document.getElementById('allergies').value = patient.allergies || '';
      document.getElementById('medications').value = patient.medications || '';
      document.getElementById('notes').value = patient.notes || '';
      document.getElementById('isActive').checked = patient.isActive !== false; // Default to true if undefined
    }
    
    // Visualizar paciente
    async function viewPatient(patientId) {
      try {
        const response = await fetch(`/api/patients/${patientId}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar dados do paciente');
        }
        
        const patient = await response.json();
        
        // Preencher dados na modal de visualiza√ß√£o
        document.getElementById('patientViewName').textContent = patient.fullName || 'N/A';
        document.getElementById('patientViewAge').textContent = calculateAge(patient.dateOfBirth);
        
        // Iniciais para o avatar
        const initials = patient.fullName
          ? patient.fullName.split(' ').map(name => name.charAt(0)).join('').substring(0, 2).toUpperCase()
          : '??';
        document.getElementById('patientViewAvatar').textContent = initials;
        
        // Informa√ß√µes pessoais
        document.getElementById('patientViewCpf').textContent = patient.cpf || 'N/A';
        document.getElementById('patientViewRg').textContent = patient.rg || 'N/A';
        document.getElementById('patientViewDob').textContent = formatDate(patient.dateOfBirth);
        document.getElementById('patientViewGender').textContent = translateGender(patient.gender);
        document.getElementById('patientViewPhone').textContent = patient.phone || 'N/A';
        document.getElementById('patientViewEmail').textContent = patient.email || 'N/A';
        document.getElementById('patientViewEmergency').textContent = patient.emergencyContact || 'N/A';
        
        const statusElement = document.getElementById('patientViewStatus');
        statusElement.textContent = patient.isActive ? 'Ativo' : 'Inativo';
        statusElement.className = `status ${patient.isActive ? 'status-active' : 'status-inactive'}`;
        
        // Endere√ßo
        document.getElementById('patientViewAddress').textContent = patient.address || 'N/A';
        document.getElementById('patientViewCity').textContent = patient.city || 'N/A';
        document.getElementById('patientViewState').textContent = patient.state || 'N/A';
        document.getElementById('patientViewZip').textContent = patient.zipCode || 'N/A';
        
        // Plano de sa√∫de
        const planName = patient.insurancePlan ? patient.insurancePlan.name : 'N/A';
        document.getElementById('patientViewPlan').textContent = planName;
        document.getElementById('patientViewPlanNumber').textContent = patient.insuranceNumber || 'N/A';
        document.getElementById('patientViewPlanExpiration').textContent = formatDate(patient.insuranceExpirationDate);
        
        // Sa√∫de
        document.getElementById('patientViewHealth').textContent = patient.healthConditions || 'Nenhuma registrada';
        document.getElementById('patientViewAllergies').textContent = patient.allergies || 'Nenhuma registrada';
        document.getElementById('patientViewMedications').textContent = patient.medications || 'Nenhuma registrada';
        
        // Observa√ß√µes
        document.getElementById('patientViewNotes').textContent = patient.notes || 'Nenhuma observa√ß√£o';
        
        // Configurar bot√£o de edi√ß√£o
        editFromViewButton.dataset.patientId = patient.id;
        
        // Abrir modal
        viewPatientModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao visualizar paciente:', error);
        alert('Erro ao carregar dados do paciente. Tente novamente.');
      }
    }
    
    // Fechar modal
    function closePatientModal() {
      patientModal.classList.remove('active');
    }
    
    // Fechar modal de visualiza√ß√£o
    function closeViewPatientModal() {
      viewPatientModal.classList.remove('active');
    }
    
    // Salvar paciente
    async function savePatient() {
      try {
        // Valida√ß√£o b√°sica
        const fullName = document.getElementById('fullName').value.trim();
        const dateOfBirth = document.getElementById('dateOfBirth').value;
        const cpf = document.getElementById('cpf').value.trim();
        const phone = document.getElementById('phone').value.trim();
        
        if (!fullName || !dateOfBirth || !cpf || !phone) {
          alert('Por favor, preencha todos os campos obrigat√≥rios.');
          return;
        }
        
        // Preparar dados do paciente
        const patientData = {
          fullName,
          dateOfBirth,
          cpf,
          rg: document.getElementById('rg').value.trim(),
          gender: document.getElementById('gender').value,
          phone,
          email: document.getElementById('email').value.trim(),
          emergencyContact: document.getElementById('emergencyContact').value.trim(),
          address: document.getElementById('address').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim(),
          zipCode: document.getElementById('zipCode').value.trim(),
          insurancePlanId: document.getElementById('insurancePlanId').value || null,
          insuranceNumber: document.getElementById('insuranceNumber').value.trim(),
          insuranceExpirationDate: document.getElementById('insuranceExpirationDate').value || null,
          healthConditions: document.getElementById('healthConditions').value.trim(),
          allergies: document.getElementById('allergies').value.trim(),
          medications: document.getElementById('medications').value.trim(),
          notes: document.getElementById('notes').value.trim(),
          isActive: document.getElementById('isActive').checked
        };
        
        const patientId = patientIdInput.value;
        let response;
        
        if (patientId) {
          // Editar paciente existente
          response = await fetch(`/api/patients/${patientId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(patientData)
          });
        } else {
          // Adicionar novo paciente
          response = await fetch('/api/patients', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(patientData)
          });
        }
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao salvar paciente');
        }
        
        // Fechar modal e recarregar lista
        closePatientModal();
        loadPatients(searchPatientInput.value);
        
        alert(patientId ? 'Paciente atualizado com sucesso!' : 'Paciente adicionado com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar paciente:', error);
        alert(`Erro ao salvar paciente: ${error.message}`);
      }
    }
    
    // Logout
    async function logout() {
      try {
        await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao fazer logout. Tente novamente.');
      }
    }
    
    // Utilidade para debounce (limitar execu√ß√£o de fun√ß√£o)
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
  </script>
</body>
</html>