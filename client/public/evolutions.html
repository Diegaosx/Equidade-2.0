<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evoluções - Clínica Equidade</title>
  <style>
    :root {
      --primary: #4b6cb7;
      --primary-dark: #3a5a9c;
      --secondary: #182848;
      --text-main: #333;
      --text-light: #666;
      --bg-light: #f5f7fa;
      --bg-white: #ffffff;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e5e7eb;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      line-height: 1.5;
    }
    
    .layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      width: 260px;
      background-color: var(--secondary);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 10;
    }
    
    .logo {
      padding: 0 20px 20px;
      font-size: 24px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    
    .nav-list {
      list-style: none;
    }
    
    .nav-item {
      margin-bottom: 5px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .nav-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 20px;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background-color: var(--bg-white);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 600;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
    }
    
    .user-info {
      margin-right: 15px;
      text-align: right;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      color: var(--text-light);
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .logout-button {
      background-color: var(--danger);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 15px;
    }
    
    .logout-button:hover {
      background-color: #dc2626;
    }
    
    /* Table */
    .table-container {
      background-color: var(--bg-white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
      margin-bottom: 30px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      color: var(--text-light);
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-pending {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }
    
    .status-completed {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-approved {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .status-rejected {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .action-button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .action-button.delete {
      color: var(--danger);
    }
    
    /* Button */
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .button-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .button-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .button-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .button-outline:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    .button-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .button-danger:hover {
      background-color: #dc2626;
    }
    
    .button-success {
      background-color: var(--success);
      color: white;
    }
    
    .button-success:hover {
      background-color: #0d9488;
    }
    
    /* Search input */
    .search-container {
      position: relative;
      width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    
    .modal-overlay.active .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.span-2 {
      grid-column: span 2;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-text {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    .error-message {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    
    .checkbox-group input {
      margin-right: 8px;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-label {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
    }
    
    .filter-control {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
      min-width: 150px;
    }
    
    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    
    .empty-icon {
      font-size: 48px;
      color: var(--text-light);
      margin-bottom: 16px;
    }
    
    .empty-text {
      font-size: 16px;
      color: var(--text-light);
      margin-bottom: 24px;
    }
    
    /* Evolution details */
    .evolution-details {
      background-color: var(--bg-white);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      padding: 20px;
    }
    
    .patient-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .patient-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .patient-meta {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .evolution-status-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 9999px;
      display: inline-flex;
    }
    
    .evolution-status-badge.pending {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }
    
    .evolution-status-badge.completed {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .evolution-status-badge.approved {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .evolution-status-badge.rejected {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .evolution-content {
      margin-bottom: 30px;
    }
    
    .evolution-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .evolution-text {
      white-space: pre-line;
      margin-bottom: 20px;
    }
    
    .evolution-meta {
      display: flex;
      justify-content: space-between;
      color: var(--text-light);
      font-size: 14px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--primary);
      color: var(--primary);
    }
    
    /* File upload */
    .file-upload {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-upload:hover {
      border-color: var(--primary);
    }
    
    .file-upload-icon {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--text-light);
    }
    
    .file-list {
      margin-top: 20px;
    }
    
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .file-name {
      display: flex;
      align-items: center;
    }
    
    .file-icon {
      margin-right: 8px;
      color: var(--text-light);
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      list-style: none;
    }
    
    .pagination li {
      margin: 0 4px;
    }
    
    .pagination a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      text-decoration: none;
      color: var(--text-main);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .pagination a:hover {
      background-color: rgba(75, 108, 183, 0.1);
    }
    
    .pagination a.active {
      background-color: var(--primary);
      color: white;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-menu {
        margin-top: 15px;
        width: 100%;
        justify-content: space-between;
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .search-container {
        width: 100%;
        margin-top: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-group.span-2 {
        grid-column: span 1;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">Clínica Equidade</div>
      <nav>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/dashboard.html" class="nav-link">
              <span class="nav-icon">📊</span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="/patients.html" class="nav-link">
              <span class="nav-icon">👥</span>
              Pacientes
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">👨‍⚕️</span>
              Profissionais
            </a>
          </li>
          <li class="nav-item">
            <a href="/appointments.html" class="nav-link">
              <span class="nav-icon">📅</span>
              Agendamentos
            </a>
          </li>
          <li class="nav-item">
            <a href="/evolutions.html" class="nav-link active">
              <span class="nav-icon">📝</span>
              Evoluções
            </a>
          </li>
          <li class="nav-item">
            <a href="/facilities.html" class="nav-link">
              <span class="nav-icon">🏥</span>
              Unidades
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">📊</span>
              Relatórios
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <span class="nav-icon">⚙️</span>
              Configurações
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    
    <main class="main-content">
      <header class="header">
        <h1 class="page-title">Registros de Evolução</h1>
        <div class="user-menu">
          <div class="user-info">
            <div class="user-name" id="userName">Carregando...</div>
            <div class="user-role" id="userRole"></div>
          </div>
          <div class="avatar" id="userAvatar">U</div>
          <button class="logout-button" id="logoutButton">Sair</button>
        </div>
      </header>
      
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Paciente</label>
          <select class="filter-control" id="patientFilter">
            <option value="">Todos os pacientes</option>
            <!-- Will be populated by JavaScript -->
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Profissional</label>
          <select class="filter-control" id="professionalFilter">
            <option value="">Todos os profissionais</option>
            <!-- Will be populated by JavaScript -->
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-control" id="statusFilter">
            <option value="">Todos os status</option>
            <option value="pending">Pendente</option>
            <option value="completed">Concluído</option>
            <option value="approved">Aprovado</option>
            <option value="rejected">Rejeitado</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Data Inicial</label>
          <input type="date" class="filter-control" id="startDateFilter">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Data Final</label>
          <input type="date" class="filter-control" id="endDateFilter">
        </div>
        
        <div class="filter-group" style="align-self: flex-end;">
          <button class="button button-primary" id="filterButton">Filtrar</button>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h2 class="card-title">Registros de Evolução</h2>
          <button class="button button-primary" id="addEvolutionBtn">Nova Evolução</button>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Paciente</th>
              <th>Profissional</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="evolutionsTableBody">
            <tr>
              <td colspan="6" class="text-center">Carregando evoluções...</td>
            </tr>
          </tbody>
        </table>
        
        <ul class="pagination" id="pagination">
          <!-- Pagination will be generated by JavaScript -->
        </ul>
      </div>
    </main>
  </div>
  
  <!-- Modal Add/Edit Evolution -->
  <div class="modal-overlay" id="evolutionModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Nova Evolução</h3>
        <button class="close-button" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="evolutionForm">
          <input type="hidden" id="evolutionId">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="patientId">Paciente *</label>
              <select id="patientId" class="form-control" required>
                <option value="">Selecione o paciente</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="appointmentId">Consulta/Atendimento</label>
              <select id="appointmentId" class="form-control">
                <option value="">Selecione o atendimento (opcional)</option>
                <!-- Will be populated by JavaScript -->
              </select>
              <div class="form-text">Selecione um atendimento ou deixe em branco para registrar evolução sem atendimento específico.</div>
            </div>
            
            <div class="form-group">
              <label for="date">Data *</label>
              <input type="date" id="date" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="type">Tipo de Evolução *</label>
              <select id="type" class="form-control" required>
                <option value="">Selecione</option>
                <option value="psychology_aba">Psicologia - ABA</option>
                <option value="psychology_cbt">Psicologia - TCC</option>
                <option value="speech_therapy">Fonoaudiologia</option>
                <option value="physical_therapy">Fisioterapia</option>
                <option value="occupational_therapy">Terapia Ocupacional</option>
                <option value="evaluation">Avaliação</option>
                <option value="other">Outro</option>
              </select>
            </div>
            
            <div class="form-group span-2">
              <label for="title">Título *</label>
              <input type="text" id="title" class="form-control" required>
            </div>
            
            <div class="form-group span-2">
              <label for="content">Conteúdo *</label>
              <textarea id="content" class="form-control" rows="8" required></textarea>
            </div>
            
            <div class="form-group">
              <label for="goals">Objetivos alcançados</label>
              <textarea id="goals" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label for="nextSteps">Próximos passos</label>
              <textarea id="nextSteps" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" class="form-control">
                <option value="pending">Pendente</option>
                <option value="completed">Concluído</option>
                <option value="approved">Aprovado</option>
                <option value="rejected">Rejeitado</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="visibility">Visibilidade</label>
              <select id="visibility" class="form-control">
                <option value="internal">Interno (apenas equipe)</option>
                <option value="guardian">Responsável (paciente/família)</option>
                <option value="public">Público (compartilhável)</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="button button-outline" id="cancelButton">Cancelar</button>
        <button class="button button-primary" id="saveButton">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal View Evolution -->
  <div class="modal-overlay" id="viewEvolutionModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes da Evolução</h3>
        <button class="close-button" id="closeViewModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <div class="tab active" id="tabDetails">Detalhes</div>
          <div class="tab" id="tabAttachments">Anexos</div>
        </div>
        
        <div id="detailsTab">
          <div class="patient-info">
            <div>
              <h3 class="patient-name" id="viewPatientName">Carregando...</h3>
              <div class="patient-meta" id="viewAppointmentInfo"></div>
            </div>
            <div class="evolution-status-badge" id="viewStatusBadge">Pendente</div>
          </div>
          
          <div class="evolution-content">
            <h4 class="evolution-title" id="viewTitle"></h4>
            <div class="evolution-text" id="viewContent"></div>
            
            <div id="viewGoalsSection">
              <h4 class="evolution-title">Objetivos Alcançados</h4>
              <div class="evolution-text" id="viewGoals"></div>
            </div>
            
            <div id="viewNextStepsSection">
              <h4 class="evolution-title">Próximos Passos</h4>
              <div class="evolution-text" id="viewNextSteps"></div>
            </div>
            
            <div class="evolution-meta">
              <div>
                <div id="viewProfessionalName"></div>
                <div id="viewDate"></div>
              </div>
              <div id="viewVisibility"></div>
            </div>
          </div>
        </div>
        
        <div id="attachmentsTab" style="display: none;">
          <div class="file-upload" id="fileUpload">
            <div class="file-upload-icon">📤</div>
            <div>Clique para selecionar ou arraste arquivos aqui</div>
            <div class="form-text">Máximo 10MB por arquivo. PDF, DOC, DOCX, JPG, PNG</div>
            <input type="file" id="fileInput" style="display: none;" multiple>
          </div>
          
          <div class="file-list" id="fileList">
            <!-- File list will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="detailsTabButtons">
          <button class="button button-danger" id="rejectButton" style="margin-right: auto;">Rejeitar</button>
          <button class="button button-success" id="approveButton">Aprovar</button>
          <button class="button button-outline" id="editEvolutionButton">Editar</button>
          <button class="button button-primary" id="closeViewButton">Fechar</button>
        </div>
        
        <div id="attachmentsTabButtons" style="display: none;">
          <button class="button button-outline" id="closeAttachmentsButton">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Verificar autenticação e carregar dados do usuário
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      setupEventListeners();
      
      // Inicializar
      loadPatients();
      loadProfessionals();
      loadEvolutions();
    });
    
    // Elementos DOM
    const userNameElement = document.getElementById('userName');
    const userRoleElement = document.getElementById('userRole');
    const userAvatarElement = document.getElementById('userAvatar');
    const logoutButton = document.getElementById('logoutButton');
    const patientFilter = document.getElementById('patientFilter');
    const professionalFilter = document.getElementById('professionalFilter');
    const statusFilter = document.getElementById('statusFilter');
    const startDateFilter = document.getElementById('startDateFilter');
    const endDateFilter = document.getElementById('endDateFilter');
    const filterButton = document.getElementById('filterButton');
    const evolutionsTableBody = document.getElementById('evolutionsTableBody');
    const paginationElement = document.getElementById('pagination');
    const addEvolutionBtn = document.getElementById('addEvolutionBtn');
    
    const evolutionModal = document.getElementById('evolutionModal');
    const viewEvolutionModal = document.getElementById('viewEvolutionModal');
    const modalTitle = document.getElementById('modalTitle');
    const evolutionForm = document.getElementById('evolutionForm');
    const evolutionIdInput = document.getElementById('evolutionId');
    const patientIdSelect = document.getElementById('patientId');
    const appointmentIdSelect = document.getElementById('appointmentId');
    const closeModal = document.getElementById('closeModal');
    const closeViewModal = document.getElementById('closeViewModal');
    const cancelButton = document.getElementById('cancelButton');
    const saveButton = document.getElementById('saveButton');
    
    const tabDetails = document.getElementById('tabDetails');
    const tabAttachments = document.getElementById('tabAttachments');
    const detailsTab = document.getElementById('detailsTab');
    const attachmentsTab = document.getElementById('attachmentsTab');
    const detailsTabButtons = document.getElementById('detailsTabButtons');
    const attachmentsTabButtons = document.getElementById('attachmentsTabButtons');
    
    const closeViewButton = document.getElementById('closeViewButton');
    const closeAttachmentsButton = document.getElementById('closeAttachmentsButton');
    const editEvolutionButton = document.getElementById('editEvolutionButton');
    const approveButton = document.getElementById('approveButton');
    const rejectButton = document.getElementById('rejectButton');
    
    // Variáveis para paginação
    let currentPage = 1;
    const pageSize = 10;
    let totalPages = 1;
    let evolutions = [];
    let filteredEvolutions = [];
    
    // Verificar autenticação
    async function checkAuth() {
      try {
        const response = await fetch('/api/user', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          // Não autenticado, redirecionar para login
          window.location.href = '/login.html';
          return;
        }
        
        const userData = await response.json();
        displayUserData(userData);
      } catch (error) {
        console.error('Erro ao verificar autenticação:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Exibir dados do usuário
    function displayUserData(user) {
      userNameElement.textContent = user.fullName;
      userRoleElement.textContent = translateRole(user.role);
      
      // Iniciais do usuário para o avatar
      const initials = user.fullName
        .split(' ')
        .map(name => name.charAt(0))
        .join('')
        .substring(0, 2)
        .toUpperCase();
      userAvatarElement.textContent = initials;
      
      // Configurar permissões baseadas no papel do usuário
      setupRoleBasedPermissions(user.role);
    }
    
    // Configurar permissões baseadas no papel do usuário
    function setupRoleBasedPermissions(role) {
      // Mostrar ou esconder botões baseado no papel
      if (['admin', 'coordinator'].includes(role)) {
        approveButton.style.display = 'block';
        rejectButton.style.display = 'block';
      } else {
        approveButton.style.display = 'none';
        rejectButton.style.display = 'none';
      }
    }
    
    // Traduzir função do inglês para português
    function translateRole(role) {
      const translations = {
        'admin': 'Administrador',
        'coordinator': 'Coordenador',
        'professional': 'Profissional',
        'intern': 'Estagiário',
        'secretary': 'Secretário(a)'
      };
      
      return translations[role] || role;
    }
    
    // Traduzir status
    function translateStatus(status) {
      const translations = {
        'pending': 'Pendente',
        'completed': 'Concluído',
        'approved': 'Aprovado',
        'rejected': 'Rejeitado'
      };
      
      return translations[status] || status;
    }
    
    // Traduzir visibilidade
    function translateVisibility(visibility) {
      const translations = {
        'internal': 'Interno (apenas equipe)',
        'guardian': 'Responsável (paciente/família)',
        'public': 'Público (compartilhável)'
      };
      
      return translations[visibility] || visibility;
    }
    
    // Traduzir tipo de evolução
    function translateEvolutionType(type) {
      const translations = {
        'psychology_aba': 'Psicologia - ABA',
        'psychology_cbt': 'Psicologia - TCC',
        'speech_therapy': 'Fonoaudiologia',
        'physical_therapy': 'Fisioterapia',
        'occupational_therapy': 'Terapia Ocupacional',
        'evaluation': 'Avaliação',
        'other': 'Outro'
      };
      
      return translations[type] || type;
    }
    
    // Formatar data
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    }
    
    // Configurar event listeners
    function setupEventListeners() {
      // Logout
      logoutButton.addEventListener('click', logout);
      
      // Filtros
      filterButton.addEventListener('click', filterEvolutions);
      
      // Adicionar evolução
      addEvolutionBtn.addEventListener('click', openAddEvolutionModal);
      
      // Fechar modal
      closeModal.addEventListener('click', closeEvolutionModal);
      closeViewModal.addEventListener('click', closeViewEvolutionModal);
      cancelButton.addEventListener('click', closeEvolutionModal);
      closeViewButton.addEventListener('click', closeViewEvolutionModal);
      closeAttachmentsButton.addEventListener('click', closeViewEvolutionModal);
      
      // Modal de background
      evolutionModal.addEventListener('click', function(e) {
        if (e.target === evolutionModal) {
          closeEvolutionModal();
        }
      });
      
      viewEvolutionModal.addEventListener('click', function(e) {
        if (e.target === viewEvolutionModal) {
          closeViewEvolutionModal();
        }
      });
      
      // Tabs
      tabDetails.addEventListener('click', function() {
        tabDetails.classList.add('active');
        tabAttachments.classList.remove('active');
        detailsTab.style.display = 'block';
        attachmentsTab.style.display = 'none';
        detailsTabButtons.style.display = 'flex';
        attachmentsTabButtons.style.display = 'none';
      });
      
      tabAttachments.addEventListener('click', function() {
        tabDetails.classList.remove('active');
        tabAttachments.classList.add('active');
        detailsTab.style.display = 'none';
        attachmentsTab.style.display = 'block';
        detailsTabButtons.style.display = 'none';
        attachmentsTabButtons.style.display = 'flex';
      });
      
      // Salvar evolução
      saveButton.addEventListener('click', saveEvolution);
      
      // Editar a partir da visualização
      editEvolutionButton.addEventListener('click', function() {
        closeViewEvolutionModal();
        editEvolution(this.dataset.evolutionId);
      });
      
      // Aprovar evolução
      approveButton.addEventListener('click', function() {
        changeEvolutionStatus(this.dataset.evolutionId, 'approved');
      });
      
      // Rejeitar evolução
      rejectButton.addEventListener('click', function() {
        changeEvolutionStatus(this.dataset.evolutionId, 'rejected');
      });
      
      // Paciente selecionado - carregar consultas relacionadas
      patientIdSelect.addEventListener('change', function() {
        const patientId = this.value;
        if (patientId) {
          loadPatientAppointments(patientId);
        } else {
          // Limpar select de consultas
          appointmentIdSelect.innerHTML = '<option value="">Selecione o atendimento (opcional)</option>';
        }
      });
    }
    
    // Carregar pacientes
    async function loadPatients() {
      try {
        const response = await fetch('/api/patients', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar pacientes');
        }
        
        const patients = await response.json();
        
        // Preencher select de filtro
        patientFilter.innerHTML = '<option value="">Todos os pacientes</option>';
        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.id;
          option.textContent = patient.fullName;
          patientFilter.appendChild(option);
        });
        
        // Preencher select do formulário
        patientIdSelect.innerHTML = '<option value="">Selecione o paciente</option>';
        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.id;
          option.textContent = patient.fullName;
          patientIdSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar pacientes:', error);
      }
    }
    
    // Carregar profissionais
    async function loadProfessionals() {
      try {
        const response = await fetch('/api/professionals', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar profissionais');
        }
        
        const professionals = await response.json();
        
        // Preencher select de filtro
        professionalFilter.innerHTML = '<option value="">Todos os profissionais</option>';
        professionals.forEach(professional => {
          const option = document.createElement('option');
          option.value = professional.id;
          option.textContent = professional.user.fullName;
          professionalFilter.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
      }
    }
    
    // Carregar consultas do paciente
    async function loadPatientAppointments(patientId) {
      try {
        const response = await fetch(`/api/patients/${patientId}/appointments`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar consultas do paciente');
        }
        
        const appointments = await response.json();
        
        // Preencher select de consultas
        appointmentIdSelect.innerHTML = '<option value="">Selecione o atendimento (opcional)</option>';
        
        // Ordenar por data (mais recente primeiro)
        appointments.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        
        appointments.forEach(appointment => {
          const date = new Date(appointment.startTime);
          const formattedDate = date.toLocaleDateString('pt-BR');
          
          const option = document.createElement('option');
          option.value = appointment.id;
          option.textContent = `${formattedDate} - ${translateEvolutionType(appointment.procedureType)}`;
          appointmentIdSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar consultas do paciente:', error);
      }
    }
    
    // Carregar evoluções
    async function loadEvolutions() {
      try {
        const url = new URL('/api/evolutions', window.location.origin);
        
        // Adicionar parâmetros de filtro, se houver
        if (patientFilter.value) {
          url.searchParams.append('patientId', patientFilter.value);
        }
        
        if (professionalFilter.value) {
          url.searchParams.append('professionalId', professionalFilter.value);
        }
        
        if (statusFilter.value) {
          url.searchParams.append('status', statusFilter.value);
        }
        
        if (startDateFilter.value) {
          url.searchParams.append('startDate', startDateFilter.value);
        }
        
        if (endDateFilter.value) {
          url.searchParams.append('endDate', endDateFilter.value);
        }
        
        const response = await fetch(url, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar evoluções');
        }
        
        evolutions = await response.json();
        filteredEvolutions = [...evolutions];
        
        // Calcular número total de páginas
        totalPages = Math.ceil(filteredEvolutions.length / pageSize);
        
        // Renderizar tabela e paginação
        renderEvolutionsTable();
        renderPagination();
      } catch (error) {
        console.error('Erro ao carregar evoluções:', error);
        evolutionsTableBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-icon">❌</div>
                <div class="empty-text">Erro ao carregar evoluções. Tente novamente.</div>
                <button class="button button-primary" onclick="loadEvolutions()">Tentar novamente</button>
              </div>
            </td>
          </tr>
        `;
      }
    }
    
    // Filtrar evoluções
    function filterEvolutions() {
      loadEvolutions();
    }
    
    // Renderizar tabela de evoluções
    function renderEvolutionsTable() {
      // Se não há evoluções
      if (filteredEvolutions.length === 0) {
        evolutionsTableBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-icon">📝</div>
                <div class="empty-text">Nenhuma evolução encontrada.</div>
                <button class="button button-primary" id="emptyAddEvolutionBtn">Nova Evolução</button>
              </div>
            </td>
          </tr>
        `;
        
        document.getElementById('emptyAddEvolutionBtn')?.addEventListener('click', openAddEvolutionModal);
        return;
      }
      
      // Calcular índices para paginação
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredEvolutions.length);
      const evolutionsToShow = filteredEvolutions.slice(startIndex, endIndex);
      
      // Limpar tabela
      evolutionsTableBody.innerHTML = '';
      
      // Adicionar linhas
      evolutionsToShow.forEach(evolution => {
        const row = document.createElement('tr');
        
        // Dados da linha
        row.innerHTML = `
          <td>${formatDate(evolution.date)}</td>
          <td>${evolution.patient?.fullName || 'N/A'}</td>
          <td>${evolution.professional?.user?.fullName || 'N/A'}</td>
          <td>${translateEvolutionType(evolution.type)}</td>
          <td><span class="status status-${evolution.status}">${translateStatus(evolution.status)}</span></td>
          <td>
            <button class="action-button view-evolution" data-id="${evolution.id}">Visualizar</button>
            <button class="action-button edit-evolution" data-id="${evolution.id}">Editar</button>
          </td>
        `;
        
        evolutionsTableBody.appendChild(row);
      });
      
      // Adicionar event listeners
      document.querySelectorAll('.view-evolution').forEach(button => {
        button.addEventListener('click', () => viewEvolution(button.dataset.id));
      });
      
      document.querySelectorAll('.edit-evolution').forEach(button => {
        button.addEventListener('click', () => editEvolution(button.dataset.id));
      });
    }
    
    // Renderizar paginação
    function renderPagination() {
      if (totalPages <= 1) {
        paginationElement.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Botão anterior
      paginationHTML += `
        <li>
          <a href="#" class="${currentPage === 1 ? 'disabled' : ''}" 
             onclick="${currentPage > 1 ? 'changePage(' + (currentPage - 1) + ')' : 'return false'}">
            &laquo;
          </a>
        </li>
      `;
      
      // Páginas numéricas
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li>
            <a href="#" class="${i === currentPage ? 'active' : ''}" 
               onclick="changePage(${i})">
              ${i}
            </a>
          </li>
        `;
      }
      
      // Botão próximo
      paginationHTML += `
        <li>
          <a href="#" class="${currentPage === totalPages ? 'disabled' : ''}" 
             onclick="${currentPage < totalPages ? 'changePage(' + (currentPage + 1) + ')' : 'return false'}">
            &raquo;
          </a>
        </li>
      `;
      
      paginationElement.innerHTML = paginationHTML;
    }
    
    // Mudar página
    function changePage(page) {
      currentPage = page;
      renderEvolutionsTable();
      renderPagination();
      return false; // Prevenir comportamento padrão do link
    }
    
    // Abrir modal para adicionar evolução
    function openAddEvolutionModal() {
      modalTitle.textContent = 'Nova Evolução';
      evolutionForm.reset();
      evolutionIdInput.value = '';
      
      // Definir data padrão como hoje
      const today = new Date();
      const dateString = today.toISOString().split('T')[0];
      document.getElementById('date').value = dateString;
      
      // Definir status padrão como "Pendente"
      document.getElementById('status').value = 'pending';
      
      evolutionModal.classList.add('active');
    }
    
    // Fechar modal
    function closeEvolutionModal() {
      evolutionModal.classList.remove('active');
    }
    
    // Fechar modal de visualização
    function closeViewEvolutionModal() {
      viewEvolutionModal.classList.remove('active');
    }
    
    // Editar evolução
    async function editEvolution(evolutionId) {
      try {
        modalTitle.textContent = 'Editar Evolução';
        
        const evolution = evolutions.find(e => e.id == evolutionId);
        
        if (!evolution) {
          // Se não encontrar no cache, buscar do servidor
          const response = await fetch(`/api/evolutions/${evolutionId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao carregar dados da evolução');
          }
          
          const evolutionData = await response.json();
          fillEvolutionForm(evolutionData);
        } else {
          fillEvolutionForm(evolution);
        }
        
        evolutionModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao editar evolução:', error);
        alert('Erro ao carregar dados da evolução. Tente novamente.');
      }
    }
    
    // Preencher formulário com dados da evolução
    function fillEvolutionForm(evolution) {
      evolutionIdInput.value = evolution.id;
      document.getElementById('patientId').value = evolution.patientId || '';
      document.getElementById('date').value = evolution.date ? new Date(evolution.date).toISOString().split('T')[0] : '';
      document.getElementById('type').value = evolution.type || '';
      document.getElementById('title').value = evolution.title || '';
      document.getElementById('content').value = evolution.content || '';
      document.getElementById('goals').value = evolution.goals || '';
      document.getElementById('nextSteps').value = evolution.nextSteps || '';
      document.getElementById('status').value = evolution.status || 'pending';
      document.getElementById('visibility').value = evolution.visibility || 'internal';
      
      // Carregar consultas do paciente e selecionar a consulta relacionada
      if (evolution.patientId) {
        loadPatientAppointments(evolution.patientId).then(() => {
          document.getElementById('appointmentId').value = evolution.appointmentId || '';
        });
      }
    }
    
    // Visualizar evolução
    async function viewEvolution(evolutionId) {
      try {
        const evolution = evolutions.find(e => e.id == evolutionId);
        
        if (!evolution) {
          // Se não encontrar no cache, buscar do servidor
          const response = await fetch(`/api/evolutions/${evolutionId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Erro ao carregar dados da evolução');
          }
          
          const evolutionData = await response.json();
          displayEvolutionDetails(evolutionData);
        } else {
          displayEvolutionDetails(evolution);
        }
        
        // Configurar botões
        editEvolutionButton.dataset.evolutionId = evolutionId;
        approveButton.dataset.evolutionId = evolutionId;
        rejectButton.dataset.evolutionId = evolutionId;
        
        // Mostrar ou esconder botões baseado no status
        if (evolution.status === 'approved' || evolution.status === 'rejected') {
          approveButton.style.display = 'none';
          rejectButton.style.display = 'none';
        } else {
          approveButton.style.display = 'block';
          rejectButton.style.display = 'block';
        }
        
        // Carregar anexos
        loadEvolutionAttachments(evolutionId);
        
        // Exibir modal
        viewEvolutionModal.classList.add('active');
      } catch (error) {
        console.error('Erro ao visualizar evolução:', error);
        alert('Erro ao carregar dados da evolução. Tente novamente.');
      }
    }
    
    // Exibir detalhes da evolução
    function displayEvolutionDetails(evolution) {
      // Informações do paciente
      document.getElementById('viewPatientName').textContent = evolution.patient?.fullName || 'N/A';
      
      // Informações do atendimento
      const appointmentInfo = evolution.appointment 
        ? `Atendimento: ${formatDate(evolution.appointment.startTime)}`
        : '';
      document.getElementById('viewAppointmentInfo').textContent = appointmentInfo;
      
      // Status
      const statusBadge = document.getElementById('viewStatusBadge');
      statusBadge.textContent = translateStatus(evolution.status);
      statusBadge.className = `evolution-status-badge ${evolution.status}`;
      
      // Conteúdo da evolução
      document.getElementById('viewTitle').textContent = evolution.title || '';
      document.getElementById('viewContent').textContent = evolution.content || '';
      
      // Objetivos alcançados (esconder se vazio)
      const goalsSection = document.getElementById('viewGoalsSection');
      if (evolution.goals) {
        document.getElementById('viewGoals').textContent = evolution.goals;
        goalsSection.style.display = 'block';
      } else {
        goalsSection.style.display = 'none';
      }
      
      // Próximos passos (esconder se vazio)
      const nextStepsSection = document.getElementById('viewNextStepsSection');
      if (evolution.nextSteps) {
        document.getElementById('viewNextSteps').textContent = evolution.nextSteps;
        nextStepsSection.style.display = 'block';
      } else {
        nextStepsSection.style.display = 'none';
      }
      
      // Metadados
      document.getElementById('viewProfessionalName').textContent = `Profissional: ${evolution.professional?.user?.fullName || 'N/A'}`;
      document.getElementById('viewDate').textContent = `Data: ${formatDate(evolution.date)}`;
      document.getElementById('viewVisibility').textContent = `Visibilidade: ${translateVisibility(evolution.visibility)}`;
    }
    
    // Carregar anexos da evolução
    async function loadEvolutionAttachments(evolutionId) {
      try {
        const response = await fetch(`/api/evolutions/${evolutionId}/attachments`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao carregar anexos');
        }
        
        const attachments = await response.json();
        const fileList = document.getElementById('fileList');
        
        if (attachments.length === 0) {
          fileList.innerHTML = '<div class="empty-text">Nenhum anexo disponível</div>';
          return;
        }
        
        fileList.innerHTML = '';
        
        attachments.forEach(attachment => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          
          const fileName = attachment.fileName || 'Arquivo';
          const fileUrl = attachment.fileUrl || '#';
          
          fileItem.innerHTML = `
            <div class="file-name">
              <span class="file-icon">📄</span>
              ${fileName}
            </div>
            <div>
              <a href="${fileUrl}" target="_blank" class="action-button">Visualizar</a>
              <button class="action-button delete" data-id="${attachment.id}">Excluir</button>
            </div>
          `;
          
          fileList.appendChild(fileItem);
        });
        
        // Adicionar event listeners para excluir
        document.querySelectorAll('.file-item .delete').forEach(button => {
          button.addEventListener('click', () => deleteAttachment(button.dataset.id));
        });
      } catch (error) {
        console.error('Erro ao carregar anexos:', error);
        document.getElementById('fileList').innerHTML = '<div class="empty-text">Erro ao carregar anexos</div>';
      }
    }
    
    // Excluir anexo
    async function deleteAttachment(attachmentId) {
      if (!confirm('Tem certeza que deseja excluir este anexo?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/attachments/${attachmentId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Erro ao excluir anexo');
        }
        
        // Recarregar anexos
        loadEvolutionAttachments(editEvolutionButton.dataset.evolutionId);
      } catch (error) {
        console.error('Erro ao excluir anexo:', error);
        alert('Erro ao excluir anexo. Tente novamente.');
      }
    }
    
    // Salvar evolução
    async function saveEvolution() {
      try {
        // Validação básica
        const patientId = document.getElementById('patientId').value;
        const date = document.getElementById('date').value;
        const type = document.getElementById('type').value;
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        
        if (!patientId || !date || !type || !title || !content) {
          alert('Por favor, preencha todos os campos obrigatórios.');
          return;
        }
        
        // Preparar dados da evolução
        const evolutionData = {
          patientId: parseInt(patientId),
          appointmentId: document.getElementById('appointmentId').value ? parseInt(document.getElementById('appointmentId').value) : null,
          date,
          type,
          title,
          content,
          goals: document.getElementById('goals').value,
          nextSteps: document.getElementById('nextSteps').value,
          status: document.getElementById('status').value,
          visibility: document.getElementById('visibility').value
        };
        
        const evolutionId = evolutionIdInput.value;
        let response;
        
        if (evolutionId) {
          // Editar evolução existente
          response = await fetch(`/api/evolutions/${evolutionId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(evolutionData)
          });
        } else {
          // Adicionar nova evolução
          response = await fetch('/api/evolutions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(evolutionData)
          });
        }
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao salvar evolução');
        }
        
        // Fechar modal e recarregar lista
        closeEvolutionModal();
        loadEvolutions();
        
        alert(evolutionId ? 'Evolução atualizada com sucesso!' : 'Evolução adicionada com sucesso!');
      } catch (error) {
        console.error('Erro ao salvar evolução:', error);
        alert(`Erro ao salvar evolução: ${error.message}`);
      }
    }
    
    // Alterar status da evolução
    async function changeEvolutionStatus(evolutionId, newStatus) {
      try {
        const response = await fetch(`/api/evolutions/${evolutionId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erro ao alterar status para ${translateStatus(newStatus)}`);
        }
        
        // Fechar modal e recarregar lista
        closeViewEvolutionModal();
        loadEvolutions();
        
        alert(`Status alterado para ${translateStatus(newStatus)} com sucesso!`);
      } catch (error) {
        console.error('Erro ao alterar status:', error);
        alert(`Erro ao alterar status: ${error.message}`);
      }
    }
    
    // Logout
    async function logout() {
      try {
        await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao fazer logout. Tente novamente.');
      }
    }
  </script>
</body>
</html>